$(document).ready(function(){const publicKey='BPaFjgpGwBvYm0gHfwW9y49PQyG4TT8mAkq9DGIBCoP33CBHcul59wbf0DQcuitkNsuZV4ytv41rrvwvA5-iCU0';let deferredPrompt,isPwa=(navigator.standalone||window.matchMedia('(display-mode: standalone)').matches),isPermission=('Notification'in window&&Notification.permission==='granted'),logDebug=(new RegExp('debug','i')).test(window.location.search);console.log=(function(oriLogFunc){return function(){if(logDebug){oriLogFunc.apply(this,arguments);}};})(console.log);window.urlBase64ToUint8Array=function(base64String){const padding='='.repeat((4-base64String.length%4)%4);const base64=(base64String+padding).replace(/\-/g,'+').replace(/_/g,'/');const rawData=window.atob(base64);const outputArray=new Uint8Array(rawData.length);for(let i=0;i<rawData.length;++i){outputArray[i]=rawData.charCodeAt(i);}
return outputArray;};window.authorize=function(){if('Notification'in window&&!isPermission&&!$.cookie('Permission')){Notification.requestPermission(function(Permission){if(Permission!=='granted'){$.cookie('Permission',Permission);}else{$.cookie('Permission',null);}});}};window.subscribe=function(){try{navigator.serviceWorker.ready.then(function(registartion){if('PushManager'in window){registartion.pushManager.subscribe({'userVisibleOnly':true,'applicationServerKey':window.urlBase64ToUint8Array(publicKey)}).then(function(pushSubscription){console.log('subscribe start');$.ajax({url:'/stat/subscribe',dataType:'json',async:true,data:JSON.stringify(pushSubscription),type:'POST',success:function(data){console.log('subscribe success');},error:function(){console.log('subscribe error');}});console.log('subscribe end');}).catch(function(error){console.log('subscribe failed:',error.toString());});}}).catch(function(err){console.log(err.toString());});}catch(e){}};(function(){isPermission||authorize();if($.cookie('Expired')){subscribe();}})();function install_stat(act,act_url){var cur_url=act_url;console.log('install stat start');$.ajax({url:'/stat/index',dataType:'json',async:true,data:{'a':navigator.standalone,'b':window.matchMedia('(display-mode: standalone)').matches,'act':act,req_url:cur_url},type:'GET',success:function(data){console.log('stat success');},error:function(){console.log('stat error');}});console.log('install stat end');}
if(navigator.serviceWorker!=null){navigator.serviceWorker.register('/sw.js?v=55',{scope:'./'}).then(function(registartion){console.log('register sw success :',registartion.scope);if('PushManager'in window){registartion.pushManager.subscribe({'userVisibleOnly':true,'applicationServerKey':window.urlBase64ToUint8Array(publicKey)}).then(function(pushSubscription){console.log('subscribe start');$.ajax({url:'/stat/subscribe',dataType:'json',async:true,data:JSON.stringify(pushSubscription),type:'POST',success:function(data){console.log('subscribe success');},error:function(){console.log('subscribe error');}});console.log('subscribe end');}).catch(function(error){console.log('subscribe failed:',error.toString());});}}).catch(function(err){console.log(err.toString());});}
window.addEventListener('appinstalled',(evt)=>{console.log('a2hs installed');install_stat('install',window.location.href);});if(!isPwa&&!$.cookie('Delayed')){window.addEventListener('beforeinstallprompt',function(event){console.log(event);$('.bot-tipsbar').slideDown(500);event.preventDefault();deferredPrompt=event;});$('.bot-tipsbar .bar-right a:first').click(function(){if(deferredPrompt!==null){deferredPrompt.prompt();deferredPrompt.userChoice.then((choiceResult)=>{if(choiceResult.outcome==='dismissed'){console.log('Not');}else{console.log('Ok');$('.bot-tipsbar').slideUp(500);$('.coupon-popup').fadeIn(500);}
deferredPrompt=null;}).catch((error)=>{console.log('install sw failed: ',error.toString());});}});$('.bot-tipsbar .bar-right a:last').click(function(){$.cookie('Delayed',true);$('.bot-tipsbar').slideUp(500);});}
navigator.serviceWorker.addEventListener('message',function(e){console.log('receive post-message from sw, action is ',e.data);if(e.data){location.href=e.data;}});if(isPwa){let domain=new RegExp('^http[s]?:\/\/[^.]+\.([^/]+)','i');let main=window.location.href.match(domain)[1].toLowerCase();$(document).on('click','a',function(event){if(this.href&&main===this.href.match(domain)[1].toLowerCase()){if(event.preventDefault){event.preventDefault();}else{window.event.returnValue=false;}
window.location=this.href;return false;}else{return true;}});install_stat('open',window.location.href);if(!$.cookie('Hidden'))
$('.coupon-popup').fadeIn(500);}});