const CACHE='igvault-mobile-page';const CASH_LIST=['js','css','jpg','png','jpeg','gif','svg','ttf','woff','eot','ico','webmanifest'];let reg=new RegExp('(?:.*\\/[^\\/]+\\.(?:'+CASH_LIST.join('|')+'))','i');const IGNORE=['cloudfront','google'];let ignoreReg=new RegExp('[^./]*(?:'+IGNORE.join('|')+')[^.]*\\.','i');let logDebug=false;console.log=(function(oriLogFunc){return function(){if(logDebug){oriLogFunc.apply(this,arguments);}};})(console.log);self.addEventListener('install',function(e){console.log('SW installing...');console.log('only install,no cache');return self.skipWaiting();});self.addEventListener('fetch',function(e){console.log('SW fetching...');if(ignoreReg.test(e.request.url)||/sw\.js/.test(e.request.url)||(!/[/-]js/.test(e.request.url)&&!reg.test(e.request.url))){return;}
console.log('cache '+e.request.url);e.respondWith(caches.match(e.request).then(function(response){e.request.mode='no-cors';return response||fetch(e.request).then(function(response){if(ignoreReg.test(e.request.url)||/sw\.js/.test(e.request.url)||(!/[/-]js/.test(e.request.url)&&!reg.test(e.request.url))){return;}
console.log('save file:'+location.href);if(!response){return;}
return caches.open(CACHE).then(function(cache){cache.delete(e.request,{ignoreSearch:true});cache.put(e.request,response.clone());return response;});});}));});self.addEventListener('activate',function(e){console.log('SW activating...');e.waitUntil(caches.keys().then(cacheNames=>{return Promise.all(cacheNames.filter(cacheNames=>{return cacheNames!==CACHE;}).map(cacheNames=>{return caches.delete(cacheNames);}));}).then(()=>{return self.clients.claim();}));});self.addEventListener('push',function(e){let data=e.data;if(e.data){data=data.json();if(navigator.userAgent.indexOf('Safari')>-1&&navigator.userAgent.indexOf('Chrome')==-1){new Notification(data.title,data.options);}else{self.registration.showNotification(data.title,data.options);}
console.log('push success');}else{console.log('push null');}});self.addEventListener('notificationclick',function(e){let data=e.notification.data;let url=data.default;let action=e.action||'default';action=action.toLowerCase();if(data.hasOwnProperty(action)){url=data[action];}
data.action=action;e.notification.close();e.waitUntil(self.clients.matchAll().then(function(clients){if(!clients||clients.length===0){self.clients.openWindow&&self.clients.openWindow(url);return;}
clients[0].focus&&clients[0].focus();clients.forEach(function(client){client.postMessage(url);});}));});self.addEventListener('notificationclose',function(e){console.log('Hi there! notification close!');});